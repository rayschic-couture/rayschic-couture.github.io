<!DOCTYPE html>
<html>
<head>
  <title>Admin Rayschic - Interface S√©curis√©e</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #2d3047 100%);
      color: white;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #2d3047;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      border-top: 4px solid #d4af37;
    }
    
    h1 {
      color: #d4af37;
      margin-bottom: 10px;
      text-align: center;
    }
    
    h1 span {
      color: white;
    }
    
    .login-section {
      background: rgba(255,255,255,0.05);
      padding: 30px;
      border-radius: 10px;
      margin: 25px 0;
      border-left: 4px solid #d4af37;
      text-align: center;
    }
    
    .admin-section {
      display: none;
    }
    
    .section {
      background: rgba(255,255,255,0.05);
      padding: 25px;
      border-radius: 10px;
      margin: 25px 0;
      border-left: 4px solid #d4af37;
    }
    
    .btn {
      background: #d4af37;
      color: #1a1a2e;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      margin: 10px 5px;
      display: inline-block;
      text-decoration: none;
      transition: all 0.3s;
    }
    
    .btn:hover {
      background: #b8941f;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: transparent;
      color: #d4af37;
      border: 2px solid #d4af37;
    }
    
    .delete-btn {
      background: #ff4757;
      color: white;
    }
    
    .upload-btn {
      background: #25D366;
      color: white;
    }
    
    .status {
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      text-align: center;
    }
    
    .success {
      background: rgba(46, 213, 115, 0.2);
      border: 1px solid #2ed573;
      color: #2ed573;
    }
    
    .error {
      background: rgba(255, 71, 87, 0.2);
      border: 1px solid #ff4757;
      color: #ff4757;
    }
    
    .warning {
      background: rgba(255, 165, 0, 0.2);
      border: 1px solid #ffa500;
      color: #ffa500;
    }
    
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .image-card {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.3s;
    }
    
    .image-card:hover {
      transform: translateY(-5px);
    }
    
    .image-preview {
      width: 100%;
      height: 140px;
      object-fit: cover;
      display: block;
    }
    
    .image-info {
      padding: 15px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-content {
      background: #2d3047;
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 100%;
      border-top: 4px solid #d4af37;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal h3 {
      color: #d4af37;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    input[type="password"],
    input[type="text"],
    input[type="file"],
    select {
      width: 100%;
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border: 1px solid #444;
      border-radius: 5px;
      color: white;
      margin: 10px 0;
      font-size: 14px;
    }
    
    input[type="file"] {
      cursor: pointer;
    }
    
    .instructions {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 8px;
      margin-top: 30px;
    }
    
    .instructions h3 {
      color: #d4af37;
      margin-bottom: 10px;
    }
    
    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #d4af37;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
      display: inline-block;
      vertical-align: middle;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .category-badge {
      display: inline-block;
      background: rgba(212, 175, 55, 0.2);
      color: #d4af37;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 11px;
      margin-right: 5px;
    }
    
    .image-actions {
      display: flex;
      gap: 5px;
      margin-top: 10px;
    }
    
    .image-actions .btn {
      flex: 1;
      padding: 8px;
      font-size: 12px;
      margin: 2px;
    }
    
    .filter-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .token-warning {
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid #ff4757;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
    }
    
    /* Nouveaux styles pour le cache buster */
    .cache-control {
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid #d4af37;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
    }
    
    .cache-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .cache-btn {
      background: rgba(212, 175, 55, 0.2);
      color: #d4af37;
      border: 1px solid #d4af37;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .cache-btn:hover {
      background: #d4af37;
      color: #1a1a2e;
    }
    
    @media (max-width: 768px) {
      .image-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      .modal-content {
        padding: 20px;
      }
      
      .btn {
        padding: 10px 15px;
        font-size: 14px;
      }
      
      .cache-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>RAY<span>SCHIC</span> Admin</h1>
    <p style="text-align: center; color: #bdc3c7; margin-bottom: 30px;">Interface s√©curis√©e de gestion des images</p>
    
    <!-- TOKEN REVOKE WARNING -->
    <div class="token-warning">
      <h3 style="color: #ff4757; margin-bottom: 10px;">‚ö†Ô∏è IMPORTANT : S√©curit√© du token</h3>
      <p>Pour votre s√©curit√©, cr√©ez un nouveau token avec uniquement les permissions n√©cessaires :</p>
      <ol style="text-align: left; margin: 10px 0; padding-left: 20px;">
        <li><strong>repo</strong> (acc√®s complet aux repositories)</li>
        <li><strong>workflow</strong> (si vous utilisez GitHub Actions)</li>
      </ol>
      <div style="margin-top: 15px;">
        <a href="https://github.com/settings/tokens/new" target="_blank" class="btn" style="background: #d4af37;">
          <i class="fas fa-key"></i> Cr√©er un nouveau token
        </a>
        <button class="btn delete-btn" onclick="clearToken()">
          <i class="fas fa-trash"></i> Effacer le token actuel
        </button>
      </div>
    </div>
    
    <!-- LOGIN SECTION -->
    <div id="loginSection" class="login-section">
      <h3>üîê Connexion S√©curis√©e</h3>
      <p style="margin-bottom: 20px; color: #aaa;">Entrez votre token GitHub pour g√©rer les images du site</p>
      
      <div style="margin: 20px 0;">
        <input type="password" id="githubToken" placeholder="Token GitHub personnel" style="width: 100%; max-width: 400px;">
        <div style="margin-top: 10px;">
          <label style="display: flex; align-items: center; color: #aaa; font-size: 12px; cursor: pointer;">
            <input type="checkbox" id="showToken" onchange="toggleTokenVisibility()" style="margin-right: 8px;">
            Afficher le token
          </label>
        </div>
        <p style="color: #2ed573; font-size: 12px; margin-top: 10px;">
          <i class="fas fa-shield-alt"></i> Stockage local s√©curis√©
        </p>
      </div>
      
      <div>
        <button class="btn" onclick="loginWithToken()">
          <i class="fas fa-lock"></i> Se connecter
        </button>
        <button class="btn btn-secondary" onclick="loginWithoutToken()">
          <i class="fab fa-github"></i> Mode GitHub direct
        </button>
      </div>
      
      <div style="margin-top: 30px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
        <h4 style="color: #d4af37; margin-bottom: 10px;">üìñ Guide rapide :</h4>
        <ol style="text-align: left; font-size: 13px; color: #aaa; padding-left: 20px;">
          <li>Cr√©ez un token sur <a href="https://github.com/settings/tokens" target="_blank" style="color: #d4af37;">GitHub Tokens</a></li>
          <li>S√©lectionnez uniquement <strong>"repo"</strong></li>
          <li>Nommez-le "Rayschic-Admin"</li>
          <li>Copiez et collez ici</li>
        </ol>
      </div>
    </div>
    
    <!-- ADMIN SECTION -->
    <div id="adminSection" class="admin-section">
      <!-- SECTION CACHE BUSTER -->
      <div class="cache-control">
        <h3 style="color: #d4af37; margin-bottom: 10px;">üîÑ Contr√¥le du Cache</h3>
        <p style="margin-bottom: 15px; color: #aaa;">Forcer le rechargement des images sur le site principal</p>
        
        <div class="cache-buttons">
          <button class="cache-btn" onclick="forceCacheBuster()">
            <i class="fas fa-sync"></i> Forcer rechargement
          </button>
          <button class="cache-btn" onclick="invalidateLocalStorage()">
            <i class="fas fa-trash-alt"></i> Vider cache local
          </button>
          <button class="cache-btn" onclick="previewSiteChanges()">
            <i class="fas fa-eye"></i> Pr√©visualiser
          </button>
        </div>
        
        <p style="margin-top: 15px; font-size: 12px; color: #2ed573;">
          <i class="fas fa-info-circle"></i> Apr√®s upload, utilisez ceci pour voir imm√©diatement les changements
        </p>
      </div>
      
      <!-- SECTION GESTION DES IMAGES -->
      <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
          <h2 style="color: #d4af37;">üñºÔ∏è Gestion des Images</h2>
          <div>
            <button class="btn btn-secondary" onclick="refreshImages()" id="refreshBtn">
              <i class="fas fa-sync-alt"></i> Actualiser
            </button>
            <button class="btn upload-btn" onclick="showUploadModal()">
              <i class="fas fa-plus"></i> Nouvelle Image
            </button>
            <button class="btn delete-btn" onclick="showDeleteAllModal()" style="background: #ff6b6b;">
              <i class="fas fa-broom"></i> Nettoyer
            </button>
            <button class="btn" onclick="logout()" style="background: #666;">
              <i class="fas fa-sign-out-alt"></i> D√©connexion
            </button>
          </div>
        </div>
        
        <!-- Filtres -->
        <div class="filter-buttons">
          <button class="btn btn-secondary active-filter" onclick="filterImages('all')">Tout</button>
          <button class="btn btn-secondary" onclick="filterImages('hero')">Hero</button>
          <button class="btn btn-secondary" onclick="filterImages('costumes')">Costumes</button>
          <button class="btn btn-secondary" onclick="filterImages('chemises')">Chemises</button>
          <button class="btn btn-secondary" onclick="filterImages('pantalons')">Pantalons</button>
          <button class="btn btn-secondary" onclick="filterImages('vestes')">Vestes</button>
          <button class="btn btn-secondary" onclick="filterImages('tenues')">Tenues</button>
          <button class="btn btn-secondary" onclick="filterImages('accessoires')">Accessoires</button>
        </div>
        
        <!-- Statistiques -->
        <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; margin: 15px 0; text-align: center;">
          <span style="color: #d4af37; font-weight: bold;" id="imageCount">0</span> images disponibles | 
          <span style="color: #2ed573; font-weight: bold;" id="cacheStatus">Cache: actif</span>
        </div>
        
        <!-- Grille d'images -->
        <div id="imageGrid" class="image-grid">
          <!-- Images will be loaded here -->
        </div>
        
        <div id="status" class="status"></div>
      </div>
      
      <!-- INSTRUCTIONS -->
      <div class="instructions">
        <h3>üìã Instructions d'utilisation :</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px;">
          <div style="background: rgba(212, 175, 55, 0.1); padding: 15px; border-radius: 8px;">
            <h4 style="color: #d4af37; margin-bottom: 10px;"><i class="fas fa-upload"></i> Upload</h4>
            <p style="font-size: 13px; color: #aaa;">Choisissez un fichier, nommez-le et s√©lectionnez une cat√©gorie</p>
          </div>
          <div style="background: rgba(46, 213, 115, 0.1); padding: 15px; border-radius: 8px;">
            <h4 style="color: #2ed573; margin-bottom: 10px;"><i class="fas fa-sync"></i> Remplacement</h4>
            <p style="font-size: 13px; color: #aaa;">Modifiez une image existante en conservant le m√™me nom</p>
          </div>
          <div style="background: rgba(255, 107, 107, 0.1); padding: 15px; border-radius: 8px;">
            <h4 style="color: #ff6b6b; margin-bottom: 10px;"><i class="fas fa-trash"></i> Suppression</h4>
            <p style="font-size: 13px; color: #aaa;">Supprimez d√©finitivement une image du repository</p>
          </div>
        </div>
        
        <p style="margin-top: 20px; color: #2ed573; padding: 10px; background: rgba(46, 213, 115, 0.1); border-radius: 5px;">
          <i class="fas fa-bolt"></i> <strong>Conseil :</strong> Apr√®s modification, utilisez "Forcer rechargement" pour voir les changements imm√©diatement
        </p>
      </div>
    </div>
  </div>

  <!-- MODAL: EDIT IMAGE -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-edit"></i> Modifier l'image</h3>
      <p id="modalFilename" style="text-align: center; color: #aaa; margin-bottom: 20px;"></p>
      
      <div style="text-align: center; margin: 20px 0;">
        <div style="position: relative; display: inline-block;">
          <img id="modalPreview" src="" style="max-width: 100%; max-height: 250px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #d4af37;" 
               onerror="this.onerror=null; this.src='https://via.placeholder.com/400x250/2d3047/d4af37?text=Image+Non+Disponible'">
          <div id="imageSizeBadge" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">
            Chargement...
          </div>
        </div>
        
        <input type="file" id="newImageInput" accept="image/jpeg,image/png,image/jpg" style="display: none;">
        <button class="btn" onclick="document.getElementById('newImageInput').click()" style="width: 100%; margin-bottom: 15px;">
          <i class="fas fa-camera"></i> Choisir une nouvelle photo
        </button>
        
        <div id="fileInfo" style="display: none; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin: 10px 0;">
          <p style="margin: 5px 0; color: #d4af37;" id="selectedFileName"></p>
          <p style="margin: 5px 0; color: #aaa; font-size: 12px;" id="selectedFileSize"></p>
          <p style="margin: 5px 0; color: #aaa; font-size: 12px;" id="selectedFileDimensions"></p>
        </div>
        
        <p style="color: #aaa; font-size: 12px;">Formats : JPG, PNG ‚Ä¢ Max 5MB ‚Ä¢ Recommand√© : 800x600px min</p>
      </div>
      
      <div class="modal-actions">
        <button class="btn" id="replaceButton" onclick="replaceImage()" style="display: none;">
          <i class="fas fa-sync-alt"></i> Remplacer l'image
        </button>
        <button class="btn delete-btn" onclick="deleteImage()">
          <i class="fas fa-trash"></i> Supprimer
        </button>
        <button class="btn btn-secondary" onclick="closeEditModal()">
          <i class="fas fa-times"></i> Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: UPLOAD NEW IMAGE -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-upload"></i> Uploader une nouvelle image</h3>
      
      <div style="margin: 20px 0;">
        <input type="file" id="uploadImageInput" accept="image/jpeg,image/png,image/jpg" style="display: none;">
        <button class="btn" onclick="document.getElementById('uploadImageInput').click()" style="width: 100%; margin-bottom: 15px;">
          <i class="fas fa-upload"></i> S√©lectionner une image
        </button>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; color: #d4af37; font-weight: bold;">Nom du fichier</label>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="uploadName" placeholder="ex: costume" style="flex: 2;">
            <select id="uploadNumber" style="flex: 1;">
              <option value="">Num√©ro</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
            </select>
            <select id="uploadExtension" style="flex: 1;">
              <option value=".jpg">.jpg</option>
              <option value=".jpeg">.jpeg</option>
              <option value=".png">.png</option>
            </select>
          </div>
          <p id="generatedFilename" style="margin-top: 5px; color: #2ed573; font-size: 12px;"></p>
        </div>
        
        <select id="uploadCategory" style="width: 100%; margin-bottom: 15px;">
          <option value="">Choisir une cat√©gorie</option>
          <option value="costumes">Costumes (costume1.jpg, etc.)</option>
          <option value="chemises">Chemises (chemise1.jpg, etc.)</option>
          <option value="pantalons">Pantalons (pantalon1.jpg, etc.)</option>
          <option value="vestes">Vestes (veste1.jpg, etc.)</option>
          <option value="tenues">Tenues (tenue1.jpg, etc.)</option>
          <option value="accessoires">Accessoires (accessoire1.jpg, etc.)</option>
          <option value="hero">Image Hero (hero.jpg)</option>
          <option value="autre">Autre</option>
        </select>
        
        <div id="uploadFileInfo" style="display: none; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
          <p style="margin: 5px 0; color: #d4af37;" id="uploadFileName"></p>
          <p style="margin: 5px 0; color: #aaa; font-size: 12px;" id="uploadFileSize"></p>
          <p style="margin: 5px 0; color: #aaa; font-size: 12px;" id="uploadFileDimensions"></p>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn upload-btn" onclick="uploadNewImage()">
          <i class="fas fa-upload"></i> Uploader
        </button>
        <button class="btn btn-secondary" onclick="closeUploadModal()">
          <i class="fas fa-times"></i> Annuler
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: DELETE ALL -->
  <div id="deleteAllModal" class="modal">
    <div class="modal-content">
      <h3><i class="fas fa-exclamation-triangle"></i> Nettoyage des images</h3>
      
      <div style="margin: 20px 0; text-align: center;">
        <div style="font-size: 5rem; color: #ff6b6b; margin-bottom: 20px;">
          <i class="fas fa-broom"></i>
        </div>
        <p style="color: #ff6b6b; font-weight: bold; margin-bottom: 15px;">ATTENTION : Action irr√©versible</p>
        <p style="color: #aaa; margin-bottom: 20px;">Cette action va v√©rifier toutes les images et supprimer celles qui ne sont plus utilis√©es dans le site.</p>
        
        <div style="background: rgba(255, 107, 107, 0.1); padding: 15px; border-radius: 8px; margin: 20px 0;">
          <h4 style="color: #ff6b6b; margin-bottom: 10px;">Images qui seront conserv√©es :</h4>
          <div id="keptImagesList" style="text-align: left; max-height: 150px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;"></div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn delete-btn" onclick="scanAndCleanImages()">
          <i class="fas fa-search"></i> Scanner d'abord
        </button>
        <button class="btn btn-secondary" onclick="closeDeleteAllModal()">
          <i class="fas fa-times"></i> Annuler
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const GITHUB_REPO = 'rayschic-couture/rayschic-couture.github.io';
    const GITHUB_BRANCH = 'main';
    const GITHUB_API = 'https://api.github.com';
    const GITHUB_RAW = 'https://raw.githubusercontent.com';
    
    let githubToken = '';
    let currentEditingImage = null;
    let selectedFile = null;
    
    // Images du site principal (DOIT correspondre √† index.html)
    const SITE_IMAGES = {
      hero: ['hero.jpg'],
      costumes: [
        'costume1.jpg', 'costume2.jpg', 'costume3.jpg', 
        'costume4.jpg', 'costume5.jpg', 'costume6.jpg'
      ],
      chemises: [
        'chemise1.jpg', 'chemise2.jpg', 'chemise3.jpg', 
        'chemise4.jpg', 'chemise5.jpg', 'chemise6.jpg'
      ],
      pantalons: [
        'pantalon1.jpg', 'pantalon2.jpg', 'pantalon3.jpg', 
        'pantalon4.jpg', 'pantalon5.jpg', 'pantalon6.jpg'
      ],
      vestes: [
        'veste1.jpg', 'veste2.jpg', 'veste3.jpg', 
        'veste4.jpg', 'veste5.jpg', 'veste6.jpg'
      ],
      tenues: [
        'tenue1.jpg', 'tenue2.jpg', 'tenue3.jpg', 
        'tenue4.jpg', 'tenue5.jpg', 'tenue6.jpg'
      ],
      accessoires: [
        'accessoire1.jpg', 'accessoire2.jpg', 'accessoire3.jpg', 
        'accessoire4.jpg', 'accessoire5.jpg', 'accessoire6.jpg'
      ]
    };
    
    // ============================================
    // INITIALISATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      loadFontAwesome();
      setupEventListeners();
      setupAutoFilenameGenerator();
      checkSavedToken();
    });
    
    function loadFontAwesome() {
      if (!document.querySelector('link[href*="font-awesome"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
        document.head.appendChild(link);
      }
    }
    
    function setupEventListeners() {
      // Edit modal file input
      document.getElementById('newImageInput').addEventListener('change', function(e) {
        if (e.target.files[0]) {
          handleImageSelection(e.target.files[0], 'edit');
        }
      });
      
      // Upload modal file input
      document.getElementById('uploadImageInput').addEventListener('change', function(e) {
        if (e.target.files[0]) {
          handleImageSelection(e.target.files[0], 'upload');
        }
      });
      
      // Auto-update filename based on category and number
      document.getElementById('uploadCategory').addEventListener('change', updateGeneratedFilename);
      document.getElementById('uploadName').addEventListener('input', updateGeneratedFilename);
      document.getElementById('uploadNumber').addEventListener('change', updateGeneratedFilename);
      document.getElementById('uploadExtension').addEventListener('change', updateGeneratedFilename);
    }
    
    function setupAutoFilenameGenerator() {
      // Set default values
      document.getElementById('uploadExtension').value = '.jpg';
    }
    
    function updateGeneratedFilename() {
      const category = document.getElementById('uploadCategory').value;
      const name = document.getElementById('uploadName').value.trim();
      const number = document.getElementById('uploadNumber').value;
      const extension = document.getElementById('uploadExtension').value;
      
      let filename = '';
      
      if (category && name) {
        filename = name + (number ? number : '') + extension;
      } else if (category) {
        // Auto-generate based on category
        const categoryNames = {
          'costumes': 'costume',
          'chemises': 'chemise',
          'pantalons': 'pantalon',
          'vestes': 'veste',
          'tenues': 'tenue',
          'accessoires': 'accessoire',
          'hero': 'hero'
        };
        
        if (categoryNames[category]) {
          filename = categoryNames[category] + (number ? number : '') + extension;
        }
      }
      
      document.getElementById('generatedFilename').textContent = filename ? 
        `Nom g√©n√©r√© : ${filename}` : 'Choisissez une cat√©gorie et un nom';
    }
    
    // ============================================
    // GESTION DU TOKEN ET CONNEXION
    // ============================================
    function checkSavedToken() {
      const savedToken = localStorage.getItem('rayschic_github_token');
      if (savedToken) {
        document.getElementById('githubToken').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        githubToken = savedToken;
        showAdminInterface();
      }
    }
    
    function loginWithToken() {
      const tokenInput = document.getElementById('githubToken');
      const token = tokenInput.value.trim();
      
      if (!token) {
        showStatus('Veuillez entrer un token GitHub', 'error');
        return;
      }
      
      // Test du token
      showStatus('<div class="spinner"></div> V√©rification du token...', '');
      
      testGitHubToken(token).then(isValid => {
        if (isValid) {
          // Masquer le token dans l'interface
          tokenInput.type = 'password';
          tokenInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
          
          // Stocker le token localement
          githubToken = token;
          localStorage.setItem('rayschic_github_token', token);
          
          showAdminInterface();
          showStatus('‚úÖ Connexion r√©ussie avec token', 'success');
        } else {
          showStatus('‚ùå Token invalide. V√©rifiez les permissions.', 'error');
          githubToken = '';
        }
      }).catch(error => {
        showStatus(`‚ùå Erreur : ${error.message}`, 'error');
      });
    }
    
    async function testGitHubToken(token) {
      try {
        const response = await fetch(`${GITHUB_API}/user`, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (response.ok) {
          const userData = await response.json();
          console.log('‚úÖ Token valide pour :', userData.login);
          return true;
        } else {
          console.log('‚ùå Token invalide');
          return false;
        }
      } catch (error) {
        console.error('Erreur test token:', error);
        return false;
      }
    }
    
    function loginWithoutToken() {
      githubToken = '';
      localStorage.removeItem('rayschic_github_token');
      showAdminInterface();
      showStatus('‚ö†Ô∏è Mode GitHub direct activ√©', 'warning');
    }
    
    function clearToken() {
      githubToken = '';
      localStorage.removeItem('rayschic_github_token');
      document.getElementById('githubToken').value = '';
      document.getElementById('githubToken').type = 'text';
      showStatus('Token effac√© localement', 'success');
    }
    
    function toggleTokenVisibility() {
      const tokenInput = document.getElementById('githubToken');
      const showToken = document.getElementById('showToken').checked;
      
      if (showToken) {
        tokenInput.type = 'text';
      } else {
        tokenInput.type = 'password';
      }
    }
    
    function showAdminInterface() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('adminSection').style.display = 'block';
      loadImages();
      updateCacheStatus();
    }
    
    function logout() {
      githubToken = '';
      localStorage.removeItem('rayschic_github_token');
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('adminSection').style.display = 'none';
      document.getElementById('githubToken').value = '';
      document.getElementById('githubToken').type = 'text';
      document.getElementById('showToken').checked = false;
      showStatus('‚úÖ D√©connexion r√©ussie', 'success');
    }
    
    // ============================================
    // GESTION DES IMAGES
    // ============================================
    async function loadImages() {
      const imageGrid = document.getElementById('imageGrid');
      const refreshBtn = document.getElementById('refreshBtn');
      
      imageGrid.innerHTML = '<div class="status"><div class="spinner"></div><p>Chargement des images...</p></div>';
      refreshBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Chargement...';
      
      try {
        let imagesHtml = '';
        let imageCount = 0;
        
        // Flatten all images into one array
        const allImages = Object.values(SITE_IMAGES).flat();
        
        // Check each image
        for (const filename of allImages) {
          const category = getCategoryFromFilename(filename);
          const imageUrl = `${GITHUB_RAW}/${GITHUB_REPO}/${GITHUB_BRANCH}/images/${filename}?t=${Date.now()}`;
          const displayName = filename.replace('.jpg', '').replace(/(\d+)/, ' $1').toUpperCase();
          
          // Test if image exists
          const exists = await testImageExists(imageUrl);
          
          imagesHtml += `
            <div class="image-card" data-category="${category}" data-exists="${exists}">
              <img src="${imageUrl}" class="image-preview" 
                   onerror="this.onerror=null; this.src='https://via.placeholder.com/200x140/2d3047/${exists ? '2ed573' : 'ff6b6b'}?text=${exists ? '‚úì' : '‚úó'}+${filename}'"
                   alt="${filename}" loading="lazy">
              <div class="image-info">
                <p style="margin: 5px 0; font-weight: bold; font-size: 14px; color: ${exists ? 'white' : '#ff6b6b'}">
                  ${displayName} ${exists ? '' : '(manquante)'}
                </p>
                <p style="margin: 3px 0; color: #aaa; font-size: 12px;">
                  <span class="category-badge" style="background: ${exists ? 'rgba(212, 175, 55, 0.2)' : 'rgba(255, 107, 107, 0.2)'}">
                    ${category}
                  </span>
                  ${filename}
                </p>
                <div class="image-actions">
                  <button class="btn" onclick="editImage('${filename}')" ${!exists ? 'style="background: #ff6b6b;"' : ''}>
                    <i class="fas fa-${exists ? 'edit' : 'plus'}"></i> ${exists ? 'Modifier' : 'Cr√©er'}
                  </button>
                  <button class="btn delete-btn" onclick="confirmDelete('${filename}')" ${!exists ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
          
          imageCount++;
        }
        
        imageGrid.innerHTML = imagesHtml;
        document.getElementById('imageCount').textContent = imageCount;
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Actualiser';
        
        showStatus(`‚úÖ ${imageCount} images charg√©es`, 'success');
        
      } catch (error) {
        imageGrid.innerHTML = `<div class="status error">
          <p>Erreur de chargement : ${error.message}</p>
          <button class="btn" onclick="loadImages()">R√©essayer</button>
        </div>`;
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Actualiser';
      }
    }
    
    async function testImageExists(url) {
      try {
        const response = await fetch(url, { method: 'HEAD' });
        return response.ok;
      } catch (error) {
        return false;
      }
    }
    
    function getCategoryFromFilename(filename) {
      if (filename === 'hero.jpg') return 'hero';
      if (filename.includes('costume')) return 'costumes';
      if (filename.includes('chemise')) return 'chemises';
      if (filename.includes('pantalon')) return 'pantalons';
      if (filename.includes('veste')) return 'vestes';
      if (filename.includes('tenue')) return 'tenues';
      if (filename.includes('accessoire')) return 'accessoires';
      return 'autre';
    }
    
    // ============================================
    // MODALES ET INTERACTIONS
    // ============================================
    function editImage(filename) {
      currentEditingImage = { filename };
      
      const modal = document.getElementById('editModal');
      const preview = document.getElementById('modalPreview');
      const filenameEl = document.getElementById('modalFilename');
      
      filenameEl.textContent = `Remplacer : ${filename}`;
      const imageUrl = `${GITHUB_RAW}/${GITHUB_REPO}/${GITHUB_BRANCH}/images/${filename}?t=${Date.now()}`;
      preview.src = imageUrl;
      
      // Get image dimensions
      getImageDimensions(imageUrl).then(dimensions => {
        document.getElementById('imageSizeBadge').textContent = dimensions;
      }).catch(() => {
        document.getElementById('imageSizeBadge').textContent = 'N/A';
      });
      
      // Reset
      document.getElementById('replaceButton').style.display = 'none';
      document.getElementById('fileInfo').style.display = 'none';
      selectedFile = null;
      
      modal.style.display = 'flex';
    }
    
    async function getImageDimensions(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
          resolve(`${this.width}√ó${this.height}px`);
        };
        img.onerror = function() {
          resolve('Dimensions inconnues');
        };
        img.src = url;
      });
    }
    
    function handleImageSelection(file, type) {
      // Validation
      if (file.size > 5 * 1024 * 1024) {
        showStatus('‚ùå Fichier trop grand (max 5MB)', 'error');
        return;
      }
      
      if (!file.type.match('image.*')) {
        showStatus('‚ùå Format non support√©. Utilisez JPG ou PNG', 'error');
        return;
      }
      
      selectedFile = file;
      
      // Display file info
      const fileSize = (file.size / 1024 / 1024).toFixed(2);
      
      // Get image dimensions
      const img = new Image();
      img.onload = function() {
        const dimensions = `${this.width}√ó${this.height}px`;
        
        if (type === 'edit') {
          document.getElementById('selectedFileName').textContent = file.name;
          document.getElementById('selectedFileSize').textContent = `${fileSize} MB`;
          document.getElementById('selectedFileDimensions').textContent = dimensions;
          document.getElementById('fileInfo').style.display = 'block';
          document.getElementById('replaceButton').style.display = 'inline-block';
          
          // Preview
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('modalPreview').src = e.target.result;
            document.getElementById('imageSizeBadge').textContent = dimensions;
          };
          reader.readAsDataURL(file);
          
        } else if (type === 'upload') {
          document.getElementById('uploadFileName').textContent = file.name;
          document.getElementById('uploadFileSize').textContent = `${fileSize} MB`;
          document.getElementById('uploadFileDimensions').textContent = dimensions;
          document.getElementById('uploadFileInfo').style.display = 'block';
          
          // Auto-set category if filename matches pattern
          const fileNameLower = file.name.toLowerCase();
          if (fileNameLower.includes('costume')) {
            document.getElementById('uploadCategory').value = 'costumes';
            document.getElementById('uploadName').value = 'costume';
          } else if (fileNameLower.includes('chemise')) {
            document.getElementById('uploadCategory').value = 'chemises';
            document.getElementById('uploadName').value = 'chemise';
          } else if (fileNameLower.includes('pantalon')) {
            document.getElementById('uploadCategory').value = 'pantalons';
            document.getElementById('uploadName').value = 'pantalon';
          } else if (fileNameLower.includes('veste')) {
            document.getElementById('uploadCategory').value = 'vestes';
            document.getElementById('uploadName').value = 'veste';
          } else if (fileNameLower.includes('tenue')) {
            document.getElementById('uploadCategory').value = 'tenues';
            document.getElementById('uploadName').value = 'tenue';
          } else if (fileNameLower.includes('accessoire')) {
            document.getElementById('uploadCategory').value = 'accessoires';
            document.getElementById('uploadName').value = 'accessoire';
          } else if (fileNameLower.includes('hero')) {
            document.getElementById('uploadCategory').value = 'hero';
            document.getElementById('uploadName').value = 'hero';
          }
          
          updateGeneratedFilename();
        }
        
        showStatus(`‚úÖ Image s√©lectionn√©e : ${file.name} (${dimensions})`, 'success');
      };
      
      img.src = URL.createObjectURL(file);
    }
    
    // ============================================
    // UPLOAD ET REMPLACEMENT
    // ============================================
    async function replaceImage() {
      if (!selectedFile || !currentEditingImage) {
        showStatus('‚ùå Aucune image s√©lectionn√©e', 'error');
        return;
      }
      
      showStatus('<div class="spinner"></div> üì§ Remplacement en cours...', '');
      
      try {
        if (githubToken) {
          // With token: direct API call
          await uploadWithToken(selectedFile, currentEditingImage.filename, 'update');
          showStatus(`‚úÖ "${currentEditingImage.filename}" remplac√© avec succ√®s !`, 'success');
          
          // Force cache refresh on main site
          setTimeout(() => forceCacheBuster(), 1000);
        } else {
          // Without token: redirect to GitHub
          redirectToGitHubUpload(currentEditingImage.filename);
        }
        
        closeEditModal();
        setTimeout(() => loadImages(), 2000);
        
      } catch (error) {
        showStatus(`‚ùå Erreur : ${error.message}`, 'error');
      }
    }
    
    async function uploadNewImage() {
      const name = document.getElementById('uploadName').value.trim();
      const number = document.getElementById('uploadNumber').value;
      const extension = document.getElementById('uploadExtension').value;
      const category = document.getElementById('uploadCategory').value;
      
      if (!selectedFile || !category) {
        showStatus('‚ùå Veuillez s√©lectionner une image et une cat√©gorie', 'error');
        return;
      }
      
      // Generate filename
      let filename;
      if (name) {
        filename = name + (number ? number : '') + extension;
      } else {
        // Auto-generate from category
        const categoryNames = {
          'costumes': 'costume',
          'chemises': 'chemise',
          'pantalons': 'pantalon',
          'vestes': 'veste',
          'tenues': 'tenue',
          'accessoires': 'accessoire',
          'hero': 'hero',
          'autre': 'image'
        };
        filename = (categoryNames[category] || 'image') + (number ? number : '') + extension;
      }
      
      // Validate filename
      if (!filename.match(/\.(jpg|jpeg|png)$/i)) {
        showStatus('‚ùå Le nom doit se terminer par .jpg, .jpeg ou .png', 'error');
        return;
      }
      
      // Check if file already exists
      const exists = await testImageExists(`${GITHUB_RAW}/${GITHUB_REPO}/${GITHUB_BRANCH}/images/${filename}`);
      if (exists && !confirm(`"${filename}" existe d√©j√†. Remplacer ?`)) {
        return;
      }
      
      showStatus('<div class="spinner"></div> üì§ Upload en cours...', '');
      
      try {
        if (githubToken) {
          // With token: direct API call
          const mode = exists ? 'update' : 'create';
          await uploadWithToken(selectedFile, filename, mode);
          showStatus(`‚úÖ "${filename}" upload√© avec succ√®s !`, 'success');
          
          // Force cache refresh on main site
          setTimeout(() => forceCacheBuster(), 1000);
        } else {
          // Without token: redirect to GitHub
          redirectToGitHubUpload(filename);
        }
        
        closeUploadModal();
        setTimeout(() => loadImages(), 2000);
        
      } catch (error) {
        showStatus(`‚ùå Erreur : ${error.message}`, 'error');
      }
    }
    
    async function uploadWithToken(file, filename, mode) {
      // Convert file to base64
      const content = await fileToBase64(file);
      
      let url = `${GITHUB_API}/repos/${GITHUB_REPO}/contents/images/${filename}`;
      let method = 'PUT';
      let body = {
        message: `${mode === 'update' ? 'Mise √† jour' : 'Ajout'}: ${filename}`,
        content: content,
        branch: GITHUB_BRANCH
      };
      
      // For update, need SHA of existing file
      if (mode === 'update') {
        try {
          const existingFile = await fetch(`${GITHUB_API}/repos/${GITHUB_REPO}/contents/images/${filename}`, {
            headers: {
              'Authorization': `token ${githubToken}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (existingFile.ok) {
            const fileData = await existingFile.json();
            body.sha = fileData.sha;
          }
        } catch (e) {
          // File doesn't exist, continue with create
        }
      }
      
      const response = await fetch(url, {
        method: method,
        headers: {
          'Authorization': `token ${githubToken}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Erreur GitHub');
      }
      
      return await response.json();
    }
    
    function redirectToGitHubUpload(filename) {
      const githubUploadURL = `https://github.com/${GITHUB_REPO}/upload/${GITHUB_BRANCH}/images`;
      
      showStatus(`
        <p>üì§ Ouvrez <a href="${githubUploadURL}" target="_blank" style="color: #d4af37; font-weight: bold;">GitHub</a> :</p>
        <ol style="text-align: left; margin: 10px 0; padding-left: 20px;">
          <li>Glissez-d√©posez le fichier</li>
          <li>Renommez-le en <strong>"${filename}"</strong></li>
          <li>Cliquez sur "Commit changes"</li>
          <li>Attendez 1-2 minutes</li>
        </ol>
        <div style="margin-top: 15px;">
          <a href="${githubUploadURL}" target="_blank" class="btn" style="background: #d4af37;">
            <i class="fab fa-github"></i> Ouvrir GitHub
          </a>
          <button class="btn btn-secondary" onclick="forceCacheBuster()">
            <i class="fas fa-sync"></i> Forcer rechargement
          </button>
        </div>
      `, 'warning');
    }
    
    // ============================================
    // SUPPRESSION
    // ============================================
    async function deleteImage() {
      if (!currentEditingImage) return;
      
      const filename = currentEditingImage.filename;
      
      if (!confirm(`‚ö†Ô∏è Supprimer d√©finitivement "${filename}" ?\n\nCette action est irr√©versible.`)) {
        return;
      }
      
      showStatus('<div class="spinner"></div> üóëÔ∏è Suppression en cours...', '');
      
      try {
        if (githubToken) {
          // Get SHA first
          const fileInfo = await fetch(`${GITHUB_API}/repos/${GITHUB_REPO}/contents/images/${filename}`, {
            headers: {
              'Authorization': `token ${githubToken}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (fileInfo.ok) {
            const data = await fileInfo.json();
            
            // Delete file
            const response = await fetch(`${GITHUB_API}/repos/${GITHUB_REPO}/contents/images/${filename}`, {
              method: 'DELETE',
              headers: {
                'Authorization': `token ${githubToken}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Suppression: ${filename}`,
                sha: data.sha,
                branch: GITHUB_BRANCH
              })
            });
            
            if (response.ok) {
              showStatus(`üóëÔ∏è "${filename}" supprim√© avec succ√®s`, 'success');
              
              // Force cache refresh
              setTimeout(() => forceCacheBuster(), 1000);
            } else {
              throw new Error('√âchec de la suppression');
            }
          }
        } else {
          showStatus('‚ùå Suppression non disponible sans token.', 'error');
        }
        
        closeEditModal();
        setTimeout(() => loadImages(), 2000);
        
      } catch (error) {
        showStatus(`‚ùå Erreur : ${error.message}`, 'error');
      }
    }
    
    function confirmDelete(filename) {
      editImage(filename);
      setTimeout(() => {
        if (confirm(`Supprimer "${filename}" ?`)) {
          deleteImage();
        } else {
          closeEditModal();
        }
      }, 100);
    }
    
    // ============================================
    // CACHE BUSTER ET PERFORMANCE
    // ============================================
    function forceCacheBuster() {
      const timestamp = Date.now();
      
      // Update localStorage cache version
      localStorage.setItem('rayschic_cache_version', timestamp.toString());
      
      // Update session cache version
      sessionStorage.setItem('rayschic_session_cache', timestamp.toString());
      
      // Notify main site if open
      try {
        if (window.opener) {
          window.opener.postMessage({
            type: 'FORCE_CACHE_REFRESH',
            timestamp: timestamp
          }, '*');
        }
      } catch (e) {
        // Cross-origin error, ignore
      }
      
      showStatus(`üîÑ Cache forc√© (${new Date(timestamp).toLocaleTimeString()})`, 'success');
      updateCacheStatus();
    }
    
    function invalidateLocalStorage() {
      // Clear all cache-related items
      localStorage.removeItem('rayschic_cache_version');
      localStorage.removeItem('rayschic_last_check');
      sessionStorage.clear();
      
      showStatus('üßπ Cache local vid√©', 'success');
      updateCacheStatus();
    }
    
    function updateCacheStatus() {
      const cacheVersion = localStorage.getItem('rayschic_cache_version');
      const statusEl = document.getElementById('cacheStatus');
      
      if (cacheVersion) {
        const date = new Date(parseInt(cacheVersion));
        statusEl.textContent = `Cache: ${date.toLocaleTimeString()}`;
        statusEl.style.color = '#2ed573';
      } else {
        statusEl.textContent = 'Cache: non forc√©';
        statusEl.style.color = '#ffa500';
      }
    }
    
    function previewSiteChanges() {
      const siteUrl = window.location.hostname === 'localhost' ? 
        'http://localhost:8080' : 
        'https://rayschic-couture.github.io';
      
      window.open(`${siteUrl}?preview=${Date.now()}`, '_blank');
    }
    
    // ============================================
    // NETTOYAGE AUTOMATIQUE
    // ============================================
    function showDeleteAllModal() {
      document.getElementById('deleteAllModal').style.display = 'flex';
      document.getElementById('keptImagesList').innerHTML = '<p style="color: #aaa; text-align: center;">Cliquez sur "Scanner" pour analyser...</p>';
    }
    
    async function scanAndCleanImages() {
      showStatus('<div class="spinner"></div> üîç Analyse des images en cours...', '');
      
      try {
        // Get list of images from GitHub
        const response = await fetch(`${GITHUB_API}/repos/${GITHUB_REPO}/contents/images`, {
          headers: githubToken ? {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          } : {}
        });
        
        if (!response.ok) {
          throw new Error('Impossible de r√©cup√©rer la liste des images');
        }
        
        const files = await response.json();
        const imageFiles = files.filter(file => file.type === 'file' && file.name.match(/\.(jpg|jpeg|png)$/i));
        
        // Flatten needed images
        const neededImages = Object.values(SITE_IMAGES).flat();
        
        // Find unused images
        const unusedImages = imageFiles.filter(file => !neededImages.includes(file.name));
        
        // Update modal with kept images
        const keptImagesList = document.getElementById('keptImagesList');
        keptImagesList.innerHTML = neededImages.length > 0 ? 
          neededImages.map(img => `<div style="padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚úì ${img}</div>`).join('') :
          '<p style="color: #ff6b6b;">Aucune image configur√©e dans SITE_IMAGES</p>';
        
        if (unusedImages.length === 0) {
          showStatus('‚úÖ Toutes les images sont utilis√©es. Aucun nettoyage n√©cessaire.', 'success');
          closeDeleteAllModal();
          return;
        }
        
        // Ask for confirmation
        const confirmMessage = `Trouv√© ${unusedImages.length} image(s) inutilis√©e(s) :\n\n` +
          unusedImages.map(img => `‚Ä¢ ${img.name}`).join('\n') +
          `\n\nSupprimer ces ${unusedImages.length} image(s) ?`;
        
        if (confirm(confirmMessage)) {
          await deleteUnusedImages(unusedImages);
        }
        
      } catch (error) {
        showStatus(`‚ùå Erreur : ${error.message}`, 'error');
      }
    }
    
    async function deleteUnusedImages(unusedImages) {
      let deletedCount = 0;
      let errorCount = 0;
      
      for (const file of unusedImages) {
        try {
          if (githubToken) {
            const deleteResponse = await fetch(`${GITHUB_API}/repos/${GITHUB_REPO}/contents/images/${file.name}`, {
              method: 'DELETE',
              headers: {
                'Authorization': `token ${githubToken}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Nettoyage: ${file.name}`,
                sha: file.sha,
                branch: GITHUB_BRANCH
              })
            });
            
            if (deleteResponse.ok) {
              deletedCount++;
              showStatus(`üóëÔ∏è Suppression: ${file.name} (${deletedCount}/${unusedImages.length})`, '');
            } else {
              errorCount++;
            }
          }
        } catch (error) {
          errorCount++;
        }
      }
      
      showStatus(`‚úÖ Nettoyage termin√© : ${deletedCount} supprim√©e(s), ${errorCount} erreur(s)`, 
                 errorCount === 0 ? 'success' : 'warning');
      
      closeDeleteAllModal();
      setTimeout(() => loadImages(), 3000);
    }
    
    // ============================================
    // UTILITAIRES
    // ============================================
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = error => reject(error);
      });
    }
    
    function showUploadModal() {
      document.getElementById('uploadModal').style.display = 'flex';
      updateGeneratedFilename();
    }
    
    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditingImage = null;
      selectedFile = null;
    }
    
    function closeUploadModal() {
      document.getElementById('uploadModal').style.display = 'none';
      document.getElementById('uploadImageInput').value = '';
      document.getElementById('uploadName').value = '';
      document.getElementById('uploadNumber').value = '';
      document.getElementById('uploadCategory').value = '';
      document.getElementById('uploadFileInfo').style.display = 'none';
      document.getElementById('generatedFilename').textContent = '';
      selectedFile = null;
    }
    
    function closeDeleteAllModal() {
      document.getElementById('deleteAllModal').style.display = 'none';
    }
    
    function refreshImages() {
      loadImages();
    }
    
    function filterImages(category) {
      const cards = document.querySelectorAll('.image-card');
      const buttons = document.querySelectorAll('.filter-buttons .btn-secondary');
      
      // Update buttons
      buttons.forEach(btn => {
        btn.classList.remove('active-filter');
        btn.style.background = 'transparent';
        btn.style.color = '#d4af37';
      });
      
      // Activate selected button
      if (category !== 'all') {
        const activeBtn = document.querySelector(`button[onclick="filterImages('${category}')"]`);
        if (activeBtn) {
          activeBtn.classList.add('active-filter');
          activeBtn.style.background = '#d4af37';
          activeBtn.style.color = '#1a1a2e';
        }
      } else {
        const allBtn = document.querySelector(`button[onclick="filterImages('all')"]`);
        if (allBtn) {
          allBtn.classList.add('active-filter');
          allBtn.style.background = '#d4af37';
          allBtn.style.color = '#1a1a2e';
        }
      }
      
      // Filter cards
      cards.forEach(card => {
        if (category === 'all' || card.dataset.category === category) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }
    
    function showStatus(message, type = '') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = message;
      statusDiv.className = `status ${type}`;
      
      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          if (statusDiv.innerHTML === message) {
            statusDiv.innerHTML = '';
            statusDiv.className = 'status';
          }
        }, 5000);
      }
    }
  </script>
</body>
</html>
